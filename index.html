<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปบันทึกการประชุม (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #fdfaf6;
            --bg-panel: #ffffff;
            --text-primary: #3d3d3d;
            --text-secondary: #7a7a7a;
            --border-color: #e5e0d9;
            --accent-color: #b5651d; /* Lighter, warmer brown */
            --accent-hover: #935218;
            --focus-ring: rgba(181, 101, 29, 0.4);
            
            --btn-action-item-bg: #8b5e34; /* Darker, desaturated brown */
            --btn-save-bg: #c4a68a; /* Lighter Tan */
            --btn-download-bg: #7f7f7f;
            --btn-format-bg: #9a8c98;
            --btn-copy-bg: #4a4e69;
            --btn-timestamp-bg: #6d6875;
            --btn-rename-bg: #6d6875;
        }

        .dark {
            --bg-main: #211f1d;
            --bg-panel: #312e2a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #4a4641;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-panel {
            background-color: var(--bg-panel);
            transition: background-color 0.3s;
        }
        .participant-box {
            background-color: var(--bg-panel);
            border: 2px solid var(--border-color);
            position: relative;
            cursor: grab;
            transition: all 0.2s ease-in-out;
        }
        .participant-box:active {
            cursor: grabbing;
        }
        .participant-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .dark .participant-box:hover {
             box-shadow: 0 4px 12px rgba(255,255,255,0.05);
        }
        .participant-box.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #d2b48c; /* Tan */
        }
        .sortable-drag {
            opacity: 1 !important;
        }

        textarea, select, input[type="text"] {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        textarea:focus, select:focus, input[type="text"]:focus {
            box-shadow: 0 0 0 3px var(--focus-ring);
            border-color: var(--accent-color);
            outline: none;
        }
        .delete-icon {
            position: absolute; top: 0.25rem; right: 0.5rem; cursor: pointer; color: #d9534f;
            font-weight: bold; display: none; font-size: 1.25rem; line-height: 1;
        }
        .participant-box:hover .delete-icon { display: block; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .tool-btn {
            font-size: 0.875rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem;
            color: white; font-weight: 500; transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        #resizer {
            width: 8px;
            cursor: col-resize;
            background-color: #e5e0d9;
            transition: background-color 0.2s;
        }
        .dark #resizer { background-color: #333; }
        #resizer:hover, #resizer.resizing {
            background-color: var(--accent-color);
        }
        /* Button Classes */
        .btn-action-item { background-color: var(--btn-action-item-bg); }
        .btn-save { background-color: var(--btn-save-bg); }
        .btn-download { background-color: var(--btn-download-bg); }
        .btn-format { background-color: var(--btn-format-bg); }
        .btn-copy { background-color: var(--btn-copy-bg); }
        .btn-timestamp { background-color: var(--btn-timestamp-bg); }
        .btn-rename { background-color: var(--btn-rename-bg); }

        .btn-action-item:hover { background-color: #734d2a; }
        .btn-save:hover { background-color: #b59575; }
        .btn-download:hover { background-color: #6b6b6b; }
        .btn-format:hover { background-color: #857884; }
        .btn-copy:hover { background-color: #3e4157; }
        .btn-timestamp:hover, .btn-rename:hover { background-color: #5a5561; }
        
        /* Search Highlight */
        .highlight {
            background-color: #fde047;
            color: black;
        }
        .dark .highlight {
            background-color: #facc15;
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            html, body {
                height: auto;
                overflow: auto;
            }
            #left-panel, #right-panel {
                flex-basis: auto !important;
                width: 100%;
                padding: 0;
            }
             #right-panel {
                min-height: 300px;
            }
            #main-container {
                 flex-direction: column;
                 gap: 1rem;
            }
            #resizer {
                display: none;
            }
        }
    </style>
</head>
<body class="">

    <div class="container mx-auto p-4 md:p-8 h-screen flex flex-col">
        <header class="text-center mb-4 flex-shrink-0 relative flex justify-between items-center">
            <div id="clock" class="absolute top-0 left-0 text-xl font-bold" style="color: var(--text-primary);"></div>
            <div class="flex-grow">
                <h1 class="text-3xl md:text-4xl font-bold">Meeting Notes</h1>
                <p style="color: var(--text-secondary);" class="mt-2">ลากและวางเพื่อจัดลำดับผู้เข้าร่วม</p>
            </div>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="setup-instructions-container"></div>

        <main id="main-container" class="flex flex-grow min-h-0">

            <!-- Left Column: Participants & AI Tools -->
            <div id="left-panel" class="flex flex-col gap-6 md:pr-3 overflow-y-auto" style="flex-basis: 33%; min-width: 250px;">
                <!-- Participants -->
                <div class="bg-panel p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">ผู้เข้าร่วม</h2>
                        <div class="flex items-center gap-2">
                            <button id="decrease-cols-btn" class="w-7 h-7 rounded-full bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 font-bold flex items-center justify-center transition">-</button>
                            <span id="cols-count" class="font-bold w-4 text-center">2</span>
                            <button id="increase-cols-btn" class="w-7 h-7 rounded-full bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 font-bold flex items-center justify-center transition">+</button>
                        </div>
                    </div>
                    <div id="participants-grid" class="grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-2">
                        <!-- JS Generated -->
                    </div>
                    <div class="mt-4">
                        <button id="add-participant-btn" class="tool-btn w-full" style="background-color: var(--accent-color);">
                            เพิ่มผู้เข้าร่วม
                        </button>
                    </div>
                </div>
                <!-- Tools -->
                <div class="bg-panel p-4 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4">เครื่องมือ</h2>
                    <div class="grid grid-cols-2 gap-2">
                         <button id="action-items-btn" class="tool-btn btn-action-item col-span-2">
                            <span class="icon-placeholder"></span> สรุป Action Items
                        </button>
                        <button id="timestamp-btn" class="tool-btn btn-timestamp"><span class="icon-placeholder"></span> แทรกเวลา</button>
                        <button id="save-btn" class="tool-btn btn-save"><span class="icon-placeholder"></span> บันทึก</button>
                        <button id="download-btn" class="tool-btn btn-download"><span class="icon-placeholder"></span> ดาวน์โหลด</button>
                        <button id="format-text-btn" class="tool-btn btn-format"><span class="icon-placeholder"></span> จัดรูปแบบ</button>
                        <button id="copy-all-btn" class="tool-btn btn-copy col-span-2"><span class="icon-placeholder"></span> คัดลอกทั้งหมด</button>
                    </div>
                </div>
            </div>

            <div id="resizer"></div>

            <!-- Right Column: Transcript Area -->
            <div id="right-panel" class="flex flex-col md:pl-3" style="flex-basis: 67%; min-width: 0;">
                 <div class="bg-panel p-6 rounded-xl shadow-sm h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h2 class="text-xl font-bold">บันทึกการประชุมทั้งหมด</h2>
                        <div class="flex items-center gap-2">
                            <input type="text" id="search-input" placeholder="ค้นหา..." class="p-1.5 border rounded-lg text-sm bg-transparent" style="border-color: var(--border-color);">
                            <button id="search-prev-btn" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">▲</button>
                            <button id="search-next-btn" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">▼</button>
                        </div>
                    </div>
                    <div class="relative w-full flex-grow">
                        <textarea id="transcript-textarea" class="w-full h-full p-4 rounded-lg focus:outline-none resize-none absolute top-0 left-0" placeholder="กำลังเชื่อมต่อกับฐานข้อมูล..."></textarea>
                        <div id="transcript-overlay" class="w-full h-full p-4 rounded-lg pointer-events-none overflow-y-auto absolute top-0 left-0 text-transparent whitespace-pre-wrap break-words"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="edit-name-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);"><h3 class="text-xl font-bold">แก้ไขชื่อผู้เข้าร่วม</h3><button class="modal-close text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div>
            <div class="p-6"><label for="edit-name-input" class="block mb-2">ชื่อใหม่:</label><input type="text" id="edit-name-input" class="w-full p-2 border rounded-lg bg-transparent" style="border-color: var(--border-color);"></div>
            <div class="p-4 border-t flex justify-end gap-2" style="border-color: var(--border-color);"><button id="edit-name-cancel" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">ยกเลิก</button><button id="edit-name-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">บันทึก</button></div>
        </div>
    </div>
    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);"><h3 id="summary-modal-title" class="text-xl font-bold">สรุป Action Items</h3><button class="modal-close text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div>
            <div id="summary-modal-content" class="p-6 overflow-y-auto"></div>
            <div class="p-4 border-t flex justify-end gap-2" style="border-color: var(--border-color);"><button id="summary-modal-copy" class="tool-btn bg-gray-600 hover:bg-gray-700">คัดลอก</button></div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b" style="border-color: var(--border-color);"><h3 id="confirm-title" class="text-xl font-bold">ยืนยัน</h3></div>
            <div class="p-6"><p id="confirm-modal-message"></p></div>
            <div class="p-4 border-t flex justify-end gap-2" style="border-color: var(--border-color);"><button id="confirm-cancel" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">ยกเลิก</button><button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">ยืนยัน</button></div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b" style="border-color: var(--border-color);"><h3 class="text-xl font-bold">แจ้งเตือน</h3></div>
            <div class="p-6"><p id="alert-modal-message"></p></div>
            <div class="p-4 border-t flex justify-end gap-2" style="border-color: var(--border-color);"><button id="alert-ok" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">ตกลง</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBe1IRZCwUy-1TlP97RRp5biHCu-surkao",
            authDomain: "my-meeting-notes-dbcb4.firebaseapp.com",
            projectId: "my-meeting-notes-dbcb4",
            storageBucket: "my-meeting-notes-dbcb4.appspot.com",
            messagingSenderId: "518603776860",
            appId: "1:518603776860:web:0c1297f45a3a8c75809799"
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                document.getElementById('main-container').style.display = 'none';
                document.querySelector('header').style.display = 'none';
                const setupContainer = document.getElementById('setup-instructions-container');
                setupContainer.innerHTML = `<div class="text-center p-8 bg-red-100 border-2 border-red-500 rounded-lg max-w-3xl mx-auto mt-8"><h2 class="text-2xl font-bold text-red-700 mb-4">⚠️ การตั้งค่ายังไม่สมบูรณ์</h2><p class="text-red-800">คุณยังไม่ได้ตั้งค่า Firebase Configuration (firebaseConfig) ในไฟล์ HTML</p><p class="mt-2 text-gray-700">กรุณาคัดลอกค่า <code>firebaseConfig</code> จากโปรเจกต์ Firebase ของคุณมาวางในโค้ดตามคู่มือที่ให้ไว้ก่อนหน้านี้ เพื่อให้แอปพลิเคชันสามารถทำงานได้</p></div>`;
                return;
            }

            // DOM Elements
            const participantsGrid = document.getElementById('participants-grid');
            const transcriptTextarea = document.getElementById('transcript-textarea');
            const transcriptOverlay = document.getElementById('transcript-overlay');
            const addParticipantBtn = document.getElementById('add-participant-btn');
            const actionItemsBtn = document.getElementById('action-items-btn');
            const decreaseColsBtn = document.getElementById('decrease-cols-btn');
            const increaseColsBtn = document.getElementById('increase-cols-btn');
            const colsCountSpan = document.getElementById('cols-count');
            const saveBtn = document.getElementById('save-btn');
            const downloadBtn = document.getElementById('download-btn');
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('left-panel');
            const formatTextBtn = document.getElementById('format-text-btn');
            const copyAllBtn = document.getElementById('copy-all-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const timestampBtn = document.getElementById('timestamp-btn');
            const searchInput = document.getElementById('search-input');
            const searchPrevBtn = document.getElementById('search-prev-btn');
            const searchNextBtn = document.getElementById('search-next-btn');
            const clockDiv = document.getElementById('clock');

            // Modal Elements
            const allModals = document.querySelectorAll('.modal-overlay');
            const summaryModal = document.getElementById('summary-modal');
            const summaryModalContent = document.getElementById('summary-modal-content');
            const summaryModalCopyBtn = document.getElementById('summary-modal-copy');
            const editNameModal = document.getElementById('edit-name-modal');
            const editNameInput = document.getElementById('edit-name-input');
            const editNameSaveBtn = document.getElementById('edit-name-save');
            const editNameCancelBtn = document.getElementById('edit-name-cancel');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-modal-message');
            const confirmOkBtn = document.getElementById('confirm-ok');
            const confirmCancelBtn = document.getElementById('confirm-cancel');
            const alertModal = document.getElementById('alert-modal');
            const alertOkBtn = document.getElementById('alert-ok');
            
            let app, auth, db, userId, meetingDocRef;
            let unsubscribeMeeting = null;
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showAlert("การตั้งค่า Firebase ไม่ถูกต้อง กรุณาตรวจสอบค่า firebaseConfig");
                return;
            }

            let participants = [];
            let activeParticipantId = null;
            let nextId = 1;
            let columnCount = 2;
            let sortableInstance = null;
            let searchState = { term: '', matches: [], currentIndex: -1 };

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    initializeLogic();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showAlert("ไม่สามารถเชื่อมต่อระบบยืนยันตัวตนได้", "error");
                    }
                }
            });

            function initializeLogic() {
                const docId = 'shared_meeting_notes';
                meetingDocRef = doc(db, 'users', userId, 'meetings', docId);

                initSortable();

                unsubscribeMeeting = onSnapshot(meetingDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (JSON.stringify(participants) !== JSON.stringify(data.participants)) {
                            participants = data.participants || [];
                            renderParticipants();
                        }
                        const maxId = participants.reduce((max, p) => p.id > max ? p.id : max, 0);
                        nextId = maxId + 1;
                        const serverTranscript = data.transcript || '';
                        if (document.activeElement !== transcriptTextarea) {
                             transcriptTextarea.value = serverTranscript;
                             handleSearch();
                        }
                        transcriptTextarea.placeholder = "คลิกชื่อผู้เข้าร่วมเพื่อเริ่มบันทึก...";
                    } else {
                        const defaultData = {
                            name: "การประชุมหลัก",
                            createdAt: new Date().toISOString(),
                            participants: [{ id: 1, name: 'ประธาน' }, { id: 2, name: 'ผู้เข้าร่วม 1' }],
                            transcript: ''
                        };
                        setDoc(meetingDocRef, defaultData);
                    }
                }, (error) => {
                    console.error("Firestore Snapshot Error: ", error);
                    showAlert("เกิดข้อผิดพลาดในการเชื่อมต่อกับฐานข้อมูล", "error");
                });

                updateColumnLayout(getInitialColumnCount());
            }
            
            function getInitialColumnCount(){
                 if (window.innerWidth < 640) return 2;
                 if (window.innerWidth < 768) return 3;
                 return 2;
            }

            function initSortable() {
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(participantsGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    delay: 150,
                    delayOnTouchOnly: true,
                    onEnd: (evt) => {
                        const { oldIndex, newIndex } = evt;
                        const [movedItem] = participants.splice(oldIndex, 1);
                        participants.splice(newIndex, 0, movedItem);
                        saveStateToFirestore();
                    },
                });
            }

            async function saveStateToFirestore() {
                if (!meetingDocRef) return;
                try {
                    await updateDoc(meetingDocRef, {
                        participants: participants,
                        transcript: transcriptTextarea.value
                    });
                } catch (error) {
                    if (error.code === 'not-found') {
                        await setDoc(meetingDocRef, {
                            participants: participants,
                            transcript: transcriptTextarea.value
                        }, { merge: true });
                    } else {
                        console.error("Error saving state to Firestore: ", error);
                    }
                }
            }
            
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            };
            const debouncedSave = debounce(saveStateToFirestore, 500);
            
            function renderParticipants() {
                participantsGrid.innerHTML = '';
                if (!participants || participants.length === 0) {
                    participantsGrid.innerHTML = `<p class="col-span-full text-center" style="color: var(--text-secondary);">ไม่มีผู้เข้าร่วมประชุม</p>`;
                    return;
                }
                participants.forEach(p => {
                    const box = document.createElement('div');
                    box.className = 'participant-box p-3 rounded-lg text-center';
                    box.dataset.id = p.id;
                    if (p.id === activeParticipantId) box.classList.add('active');
                    const nameElement = document.createElement('h3');
                    nameElement.className = 'font-bold text-sm truncate';
                    nameElement.textContent = p.name;
                    const editButton = document.createElement('button');
                    editButton.textContent = 'แก้ไข';
                    editButton.className = 'text-xs w-full mt-1 hover:underline';
                    editButton.style.color = 'var(--text-secondary)';
                    const deleteIcon = document.createElement('span');
                    deleteIcon.className = 'delete-icon';
                    deleteIcon.innerHTML = '&times;';
                    box.appendChild(deleteIcon);
                    box.appendChild(nameElement);
                    box.appendChild(editButton);
                    box.addEventListener('click', () => handleParticipantSelect(p.id));
                    editButton.addEventListener('click', (e) => { e.stopPropagation(); handleNameEdit(p.id); });
                    deleteIcon.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteParticipant(p.id); });
                    participantsGrid.appendChild(box);
                });
                initSortable();
            }
            
            function updateColumnLayout(newCount) {
                columnCount = newCount;
                participantsGrid.className = `grid gap-4 grid-cols-${columnCount}`;
                colsCountSpan.textContent = columnCount;
            }
            
            function hideAllModals() {
                allModals.forEach(modal => modal.classList.add('hidden'));
            }
            
            function showAlert(message) {
                alertModal.querySelector('#alert-modal-message').textContent = message;
                alertModal.classList.remove('hidden');
            }

            function handleParticipantSelect(id) {
                activeParticipantId = id;
                renderParticipants();
                const participant = participants.find(p => p.id === id);
                if (!participant) return;
                const currentText = transcriptTextarea.value;
                const textToInsert = `\t${participant.name}  :  `;
                const newText = (currentText.length > 0 && !currentText.endsWith('\n')) 
                    ? `${currentText}\n${textToInsert}` 
                    : `${currentText}${textToInsert}`;
                transcriptTextarea.value = newText;
                transcriptTextarea.focus();
                transcriptTextarea.setSelectionRange(transcriptTextarea.value.length, transcriptTextarea.value.length);
                transcriptTextarea.scrollTop = transcriptTextarea.scrollHeight;
                debouncedSave();
            }

            function handleNameEdit(id) {
                const input = editNameInput;
                const participant = participants.find(p => p.id === id);
                if (participant) { 
                    input.dataset.id = id;
                    input.value = participant.name;
                    editNameModal.classList.remove('hidden'); 
                    input.focus();
                }
            }

            editNameSaveBtn.addEventListener('click', () => {
                const newName = editNameInput.value.trim();
                const id = parseInt(editNameInput.dataset.id);
                if (newName && id) {
                    const participant = participants.find(p => p.id === id);
                    if (participant) { 
                        participant.name = newName; 
                        hideAllModals(); 
                        renderParticipants();
                        saveStateToFirestore();
                    }
                }
            });
            
            function handleDeleteParticipant(id) {
                confirmTitle.textContent = "ยืนยันการลบผู้เข้าร่วม";
                const participant = participants.find(p => p.id === id);
                if (participant) {
                    confirmMessage.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบ "${participant.name}" ออกจากรายชื่อ?`;
                    confirmOkBtn.onclick = () => {
                        participants = participants.filter(p => p.id !== id);
                        renderParticipants();
                        saveStateToFirestore();
                        hideAllModals();
                    };
                    confirmModal.classList.remove('hidden');
                }
            }
            
            transcriptTextarea.addEventListener('input', () => {
                debouncedSave();
                handleSearch();
                transcriptOverlay.scrollTop = transcriptTextarea.scrollTop;
            });
            transcriptTextarea.addEventListener('scroll', () => {
                transcriptOverlay.scrollTop = transcriptTextarea.scrollTop;
            });
            
            addParticipantBtn.addEventListener('click', () => {
                const newParticipant = { id: nextId, name: `ผู้เข้าร่วม ${nextId}` };
                nextId++;
                participants.push(newParticipant);
                renderParticipants();
                saveStateToFirestore();
            });

            increaseColsBtn.addEventListener('click', () => { if (columnCount < 6) updateColumnLayout(columnCount + 1); });
            decreaseColsBtn.addEventListener('click', () => { if (columnCount > 1) updateColumnLayout(columnCount - 1); });

            saveBtn.addEventListener('click', saveStateToFirestore);

            downloadBtn.addEventListener('click', () => {
                const text = transcriptTextarea.value;
                if (text.trim() === '') {
                    showAlert('ไม่มีเนื้อหาให้ดาวน์โหลด');
                    return;
                }

                // Create HTML content for Word document
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                    "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                    "xmlns='http://www.w3.org/TR/REC-html40'>"+
                    "<head><meta charset='utf-8'><title>Meeting Notes</title></head><body>";
                const footer = "</body></html>";
                // Use <pre> tag to preserve whitespace and newlines
                const content = `<pre>${text.replace(/\t/g, '&#9;')}</pre>`;
                const sourceHTML = header + content + footer;

                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `meeting-notes-${new Date().toISOString().slice(0,10)}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
            });
            
            copyAllBtn.addEventListener('click', () => {
                const textToCopy = transcriptTextarea.value;
                if (textToCopy.trim() === '') { showAlert('ไม่มีเนื้อหาให้คัดลอก'); return; }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showAlert('คัดลอกบันทึกทั้งหมดแล้ว');
                }, () => {
                    showAlert('เกิดข้อผิดพลาดในการคัดลอก');
                });
            });

            formatTextBtn.addEventListener('click', () => {
                const originalText = transcriptTextarea.value;
                if (originalText.trim() === '') { showAlert('ไม่มีเนื้อหาให้จัดรูปแบบ'); return; }
                const lines = originalText.split('\n');
                const formattedLines = lines.map(line => {
                    const separator = '  :  ';
                    if (line.includes(separator)) {
                        const parts = line.split(separator);
                        let speakerPart = parts[0];
                        let speechPart = parts.slice(1).join(separator);
                        const thaiNumerals = ['๐', '๑', '๒', '๓', '๔', '๕', '๖', '๗', '๘', '๙'];
                        speechPart = speechPart.replace(/[0-9]/g, d => thaiNumerals[d]);
                        const fillerWords = /ครับผม|นะครับ|ครับ|ค่ะ|คะ/g;
                        speechPart = speechPart.replace(fillerWords, '');
                        speechPart = speechPart.replace(/ไหม/g, 'หรือไม่');
                        speechPart = speechPart.replace(/ยังไง/g, 'อย่างไร');
                        speechPart = speechPart.replace(/เมื่อกี้/g, 'เมื่อสักครู่');
                        speechPart = speechPart.replace(/ +/g, ' ').trim();
                        return `${speakerPart}${separator}${speechPart}`;
                    }
                    return line; 
                });
                const newText = formattedLines.join('\n');
                transcriptTextarea.value = newText;
                saveStateToFirestore();
                showAlert('จัดรูปแบบข้อความเรียบร้อยแล้ว');
            });
            
            actionItemsBtn.addEventListener('click', () => {
                const fullNotes = transcriptTextarea.value;
                if (fullNotes.trim() === '') { showAlert('ไม่มีเนื้อหาสำหรับสรุป'); return; }
                const keywords = ["มอบหมาย", "ต้องทำ", "รับผิดชอบ", "ฝาก", "ติดตาม", "ดำเนินการ"];
                const lines = fullNotes.split('\n');
                const actionItems = lines.filter(line => {
                    const parts = line.split(' : ');
                    if (parts.length > 1) {
                        const speechPart = parts[1];
                        return keywords.some(keyword => speechPart.includes(keyword));
                    }
                    return false;
                });
                summaryModal.classList.remove('hidden');
                if (actionItems.length > 0) {
                    summaryModalContent.innerHTML = actionItems.map(item => `<div>${item.trim()}</div>`).join('');
                } else {
                    summaryModalContent.innerHTML = `<p class="text-gray-500">ไม่พบ Action Items ในบันทึกการประชุม</p>`;
                }
            });

            summaryModalCopyBtn.addEventListener('click', () => {
                const content = summaryModalContent.innerText;
                 if (content.trim() === '' || content.includes("ไม่พบ Action Items")) { showAlert('ไม่มีเนื้อหาให้คัดลอก'); return; }
                navigator.clipboard.writeText(content).then(() => { showAlert('คัดลอกสรุป Action Items แล้ว'); }, () => { showAlert('เกิดข้อผิดพลาดในการคัดลอก'); });
            });

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                document.getElementById('theme-icon-light').classList.toggle('hidden');
                document.getElementById('theme-icon-dark').classList.toggle('hidden');
                localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
            });
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
                document.getElementById('theme-icon-light').classList.add('hidden');
                document.getElementById('theme-icon-dark').classList.remove('hidden');
            }

            timestampBtn.addEventListener('click', insertTimestamp);
            function insertTimestamp() {
                const now = new Date();
                const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}] `;
                const start = transcriptTextarea.selectionStart;
                const end = transcriptTextarea.selectionEnd;
                transcriptTextarea.value = transcriptTextarea.value.substring(0, start) + timeString + transcriptTextarea.value.substring(end);
                transcriptTextarea.selectionStart = transcriptTextarea.selectionEnd = start + timeString.length;
                transcriptTextarea.focus();
                saveStateToFirestore();
            }

            searchInput.addEventListener('input', handleSearch);
            searchNextBtn.addEventListener('click', () => navigateSearch(1));
            searchPrevBtn.addEventListener('click', () => navigateSearch(-1));
            function handleSearch() {
                const term = searchInput.value;
                const content = transcriptTextarea.value;
                if (!term) {
                    transcriptOverlay.innerHTML = '';
                    searchState = { term: '', matches: [], currentIndex: -1 };
                    return;
                }
                const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                let match;
                searchState.matches = [];
                while ((match = regex.exec(content)) !== null) {
                    searchState.matches.push({ index: match.index, length: match[0].length });
                }
                searchState.term = term;
                searchState.currentIndex = searchState.matches.length > 0 ? 0 : -1;
                renderHighlights();
            }
            function navigateSearch(direction) {
                if (searchState.matches.length === 0) return;
                searchState.currentIndex += direction;
                if (searchState.currentIndex >= searchState.matches.length) searchState.currentIndex = 0;
                if (searchState.currentIndex < 0) searchState.currentIndex = searchState.matches.length - 1;
                renderHighlights();
            }
            function renderHighlights() {
                let highlightedContent = '';
                let lastIndex = 0;
                const content = transcriptTextarea.value;
                searchState.matches.forEach((match, i) => {
                    highlightedContent += content.substring(lastIndex, match.index).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const isCurrent = i === searchState.currentIndex;
                    highlightedContent += `<mark class="${isCurrent ? 'bg-yellow-500' : 'bg-yellow-300'}">${content.substring(match.index, match.index + match.length).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</mark>`;
                    lastIndex = match.index + match.length;
                });
                highlightedContent += content.substring(lastIndex).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                transcriptOverlay.innerHTML = highlightedContent;
                if (searchState.currentIndex !== -1) {
                    const currentMatch = searchState.matches[searchState.currentIndex];
                    const temp = transcriptTextarea.value.substring(0, currentMatch.index);
                    const lines = temp.split('\n').length;
                    transcriptTextarea.scrollTop = (lines - 5) * 16; 
                }
            }

            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    if (e.key === 's') { e.preventDefault(); saveBtn.click(); } 
                    else if (e.key === 't') { e.preventDefault(); insertTimestamp(); } 
                    else if (!isNaN(parseInt(e.key)) && e.key >= '1' && e.key <= '9') {
                        e.preventDefault();
                        const participantIndex = parseInt(e.key) - 1;
                        if (participants && participants[participantIndex]) {
                            handleParticipantSelect(participants[participantIndex].id);
                        }
                    }
                }
            });

            let isResizing = false;
            const handleMouseMove = (e) => {
                if (!isResizing) return;
                const event = e.touches ? e.touches[0] : e;
                const container = document.getElementById('main-container');
                const containerRect = container.getBoundingClientRect();
                let newLeftWidth = event.clientX - containerRect.left;
                const minWidth = 250;
                if (newLeftWidth < minWidth) newLeftWidth = minWidth;
                if (newLeftWidth > containerRect.width - minWidth - resizer.offsetWidth) {
                    newLeftWidth = containerRect.width - minWidth - resizer.offsetWidth;
                }
                leftPanel.style.flexBasis = `${newLeftWidth}px`;
            };
            const stopResizing = () => {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', stopResizing);
                document.removeEventListener('touchmove', handleMouseMove);
                document.removeEventListener('touchend', stopResizing);
            };
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('resizing');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', stopResizing);
            });
            resizer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('resizing');
                document.addEventListener('touchmove', handleMouseMove);
                document.addEventListener('touchend', stopResizing);
            });
            
            setInterval(() => {
                const now = new Date();
                clockDiv.textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }, 1000);

            const icons = {
                'action-items-btn': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`,
                'timestamp-btn': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'save-btn': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>`,
                'download-btn': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`,
                'format-text-btn': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`,
                'copy-all-btn': `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`
            };
            document.querySelectorAll('.icon-placeholder').forEach(el => {
                el.innerHTML = icons[el.parentElement.id];
            });

            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', hideAllModals));
            allModals.forEach(modal => modal.addEventListener('click', (e) => { if(e.target === modal) hideAllModals(); }));
            editNameCancelBtn.addEventListener('click', hideAllModals);
            confirmCancelBtn.addEventListener('click', hideAllModals);
            alertOkBtn.addEventListener('click', hideAllModals);
        });
    </script>
</body>
</html>
