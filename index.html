<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>แอปบันทึกการประชุม (Minimalist Dark)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use cdnjs for reliable SortableJS loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme */
            --bg-gradient-start: #f9fafb;
            --bg-gradient-end: #f3f4f6;
            --bg-panel: rgba(255, 255, 255, 0.8);
            --bg-panel-solid: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: rgba(209, 213, 219, 0.6);
            --accent-color: #374151;
            --focus-ring: rgba(55, 65, 81, 0.2);
            --btn-base-bg: #4b5563;
            --btn-base-hover: #1f2937;
            --btn-text: #ffffff;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        }

        .dark {
            /* Dark Theme */
            --bg-gradient-start: #000000;
            --bg-gradient-end: #18181b;
            --bg-panel: rgba(24, 24, 27, 0.6);
            --bg-panel-solid: #18181b;
            --text-primary: #e4e4e7;
            --text-secondary: #71717a;
            --border-color: rgba(63, 63, 70, 0.4);
            --accent-color: #a1a1aa;
            --focus-ring: rgba(161, 161, 170, 0.2);
            --btn-base-bg: #27272a;
            --btn-base-hover: #3f3f46;
            --btn-text: #e4e4e7;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.7);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(180deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-primary);
            transition: color 0.3s, background 0.3s;
        }

        /* --- FIXED: Custom Line Clamp Class --- */
        .custom-line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;  
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            max-height: 3em; /* Fallback for lineHeight ~1.5 */
        }

        /* Ratio Mode */
        body.has-ratio {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000 !important;
        }
        #app-container.ratio-mode {
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            box-shadow: 0 0 0 1px var(--border-color), 0 0 60px rgba(0,0,0,0.8);
            max-width: none !important;
            height: auto !important;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #app-container.ratio-16-9 {
            width: min(98vw, calc(98vh * 16 / 9)) !important;
            height: min(98vh, calc(98vw * 9 / 16)) !important;
        }
        #app-container.ratio-4-3 {
            width: min(98vw, calc(98vh * 4 / 3)) !important;
            height: min(98vh, calc(98vw * 3 / 4)) !important;
        }

        /* Glass Panel */
        .bg-panel {
            background-color: var(--bg-panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Participant Cards */
        .participant-box {
            background-color: var(--bg-panel-solid);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            position: relative;
            cursor: pointer;
            transition: all 0.15s ease-out;
            border-radius: 0.5rem;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: auto;
            min-height: 75px; /* Compact height */
        }
        .participant-box:active {
            transform: scale(0.96);
            border-color: var(--accent-color);
            background-color: rgba(255, 255, 255, 0.05);
        }
        .participant-box:hover {
            border-color: var(--accent-color);
            box-shadow: var(--card-shadow-hover);
        }
        .participant-box.active {
            border-color: var(--accent-color);
            background-color: rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 0 0 1px var(--accent-color);
        }
        .dark .participant-box.active {
             background-color: rgba(255, 255, 255, 0.05);
        }

        .sortable-ghost { opacity: 0.3; background: var(--accent-color); }
        .sortable-drag { opacity: 1 !important; cursor: grabbing; }

        /* Inputs */
        textarea, select, input[type="text"] {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        textarea:focus, select:focus, input[type="text"]:focus {
            box-shadow: 0 0 0 2px var(--focus-ring);
            border-color: var(--accent-color);
            background-color: var(--bg-panel-solid);
            outline: none;
        }

        /* Action Icons */
        .card-action-icon {
            position: absolute;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--text-secondary);
            transition: all 0.2s;
            opacity: 0.6;
            z-index: 10;
        }
        .card-action-icon:hover, .card-action-icon:active {
            opacity: 1;
            background-color: rgba(128, 128, 128, 0.1);
            color: var(--text-primary);
        }
        .delete-icon { top: 2px; right: 2px; }
        .edit-icon { bottom: 2px; right: 2px; }
        .delete-icon:hover { color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
        
        .modal-overlay { backdrop-filter: blur(8px); transition: opacity 0.3s ease; }
        
        /* Buttons */
        .tool-btn {
            font-size: 0.875rem; 
            padding: 0.6rem 0.75rem; 
            border-radius: 0.5rem;
            color: var(--btn-text);
            font-weight: 500; 
            transition: all 0.2s;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem;
            background-color: var(--btn-base-bg);
            border: 1px solid transparent;
            height: 100%;
            touch-action: manipulation;
        }
        .dark .tool-btn {
            border: 1px solid var(--border-color);
        }
        .tool-btn:hover {
            background-color: var(--btn-base-hover);
            transform: translateY(-1px);
        }
        .tool-btn:active { transform: translateY(0); }
        .tool-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        #resizer {
            width: 5px; 
            cursor: col-resize; 
            background-color: rgba(0, 0, 0, 0.15);
            transition: background-color 0.2s; 
            margin: 0 3px;
            border-radius: 99px;
        }
        .dark #resizer {
            background-color: rgba(255, 255, 255, 0.15);
        }
        #resizer:hover, #resizer.resizing { 
            background-color: var(--accent-color); 
            opacity: 1;
        }
        
        /* Saved List Item */
        .saved-list-item {
            border: 1px solid var(--border-color);
            background-color: var(--bg-panel-solid);
            color: var(--text-primary);
        }
        .list-item-action { visibility: hidden; color: var(--text-secondary); }
        .list-item-action:hover { color: #ef4444; }
        .saved-list-item:hover .list-item-action { visibility: visible; }

        /* Toast & Status */
        #toast-container {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 100;
            display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none;
        }
        .toast {
            background-color: var(--text-primary); color: var(--bg-panel-solid);
            padding: 0.5rem 1.25rem; border-radius: 999px;
            font-size: 0.85rem; opacity: 0; transform: translateY(1rem);
            transition: all 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        #save-status {
            font-size: 0.75rem; color: var(--text-secondary);
            display: flex; align-items: center; gap: 0.35rem; opacity: 0.8;
            background: var(--bg-panel-solid); border: 1px solid var(--border-color);
            padding: 4px 10px; border-radius: 999px;
        }
        #save-status.saving { color: var(--text-primary); border-color: var(--text-primary); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        @media (max-width: 767px) {
            html, body { height: auto; overflow: auto; }
            #left-panel, #right-panel { flex-basis: auto !important; width: 100%; padding: 0; }
            #right-panel { min-height: 400px; }
            #main-container { flex-direction: column; gap: 1rem; }
            #resizer { display: none; }
        }
    </style>
</head>
<body class="dark">

    <div id="app-container" class="container mx-auto p-4 md:p-6 h-screen flex flex-col transition-all duration-300">
        <!-- Header -->
        <header class="flex-shrink-0 relative flex justify-between items-center mb-6 px-2">
            <div class="flex items-center gap-3">
                <button id="toggle-sidebar-btn" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-zinc-800 transition text-gray-500 dark:text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div id="clock" class="text-lg font-mono tracking-tight" style="color: var(--text-secondary);"></div>
            </div>

            <div class="absolute left-1/2 transform -translate-x-1/2 text-center">
                <h1 class="text-xl md:text-2xl font-semibold tracking-wide uppercase" style="color: var(--text-primary);">Meeting Notes</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <button id="ratio-toggle" class="px-3 py-1 text-xs font-mono border rounded hover:bg-white dark:hover:bg-zinc-800 transition" style="border-color: var(--border-color); color: var(--text-secondary);">
                    AUTO
                </button>
                <button id="theme-toggle" class="p-2 rounded hover:bg-gray-200 dark:hover:bg-zinc-800 transition text-gray-500 dark:text-gray-400">
                    <svg id="theme-icon-light" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <div id="setup-instructions-container"></div>

        <main id="main-container" class="flex flex-grow min-h-0 gap-4">

            <!-- Left Column: Participants & AI Tools -->
            <div id="left-panel" class="flex flex-col gap-4 overflow-y-auto pr-1" style="flex-basis: 33%; min-width: 280px;">
                <!-- Participants Panel -->
                <div class="bg-panel p-5 rounded-lg shadow-sm flex-shrink-0">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                            Participants
                        </h2>
                        <div class="flex items-center gap-1">
                            <button id="decrease-cols-btn" class="w-6 h-6 rounded bg-transparent border border-gray-200 dark:border-zinc-700 hover:bg-gray-100 dark:hover:bg-zinc-800 flex items-center justify-center transition text-xs text-gray-500">-</button>
                            <span id="cols-count" class="font-mono text-xs w-6 text-center text-gray-500">2</span>
                            <button id="increase-cols-btn" class="w-6 h-6 rounded bg-transparent border border-gray-200 dark:border-zinc-700 hover:bg-gray-100 dark:hover:bg-zinc-800 flex items-center justify-center transition text-xs text-gray-500">+</button>
                        </div>
                    </div>
                    
                    <div id="participants-grid" class="grid gap-3 grid-cols-2 sm:grid-cols-3 md:grid-cols-2 mb-4">
                        <!-- JS Generated -->
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button id="add-participant-btn" class="tool-btn">
                            ADD
                        </button>
                        <button id="bulk-add-btn" class="tool-btn">
                            PASTE LIST
                        </button>
                        <button id="import-excel-btn" class="tool-btn">
                            IMPORT XLS
                        </button>
                         <button id="clear-all-btn" class="tool-btn">
                            CLEAR ALL
                        </button>
                        <button id="save-list-btn" class="tool-btn">
                            SAVE GROUP
                        </button>
                         <button id="load-list-btn" class="tool-btn">
                            LOAD GROUP
                        </button>
                        <input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden" />
                    </div>
                </div>

                <!-- Tools Panel -->
                <div class="bg-panel p-5 rounded-lg shadow-sm transition-all duration-300">
                    <div class="flex justify-between items-center cursor-pointer mb-2" id="tools-header">
                        <h2 class="text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                            Tools
                        </h2>
                        <button class="p-1 rounded hover:bg-gray-200 dark:hover:bg-zinc-800 transition transform duration-300 text-gray-500" id="tools-chevron">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                    <div id="tools-content" class="grid grid-cols-2 gap-2 overflow-hidden transition-all duration-300">
                        <button id="undo-btn" class="tool-btn" disabled>UNDO</button>
                        <button id="redo-btn" class="tool-btn" disabled>REDO</button>
                        <button id="timestamp-btn" class="tool-btn">TIME</button>
                        <button id="copy-all-btn" class="tool-btn">COPY</button>
                        <button id="save-btn" class="tool-btn">SAVE</button>
                        <button id="download-btn" class="tool-btn">DOWNLOAD</button>
                        <button id="clear-text-btn" class="tool-btn col-span-2 text-red-400 hover:text-red-300 hover:bg-red-900/20 border-red-900/30">CLEAR TEXT</button>
                    </div>
                </div>
            </div>

            <div id="resizer"></div>

            <!-- Right Column: Transcript Area -->
            <div id="right-panel" class="flex flex-col flex-grow" style="flex-basis: 67%; min-width: 0;">
                 <div class="bg-panel p-6 rounded-lg shadow-sm h-full flex flex-col relative">
                    <!-- Save Status Indicator -->
                    <div id="save-status" class="absolute bottom-4 right-6 z-10 select-none">
                         <svg class="w-3 h-3 animate-spin hidden" id="save-spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                         <span id="save-text">READY</span>
                    </div>

                    <div class="relative w-full flex-grow">
                        <textarea id="transcript-textarea" class="w-full h-full p-4 rounded-lg focus:outline-none resize-none absolute top-0 left-0 text-base leading-relaxed font-mono" placeholder="Start typing..."></textarea>
                        <div id="transcript-overlay" class="w-full h-full p-4 rounded-lg pointer-events-none overflow-y-auto absolute top-0 left-0 text-transparent whitespace-pre-wrap break-words text-base leading-relaxed font-mono"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="edit-name-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-2xl w-full max-w-md">
            <div class="p-5 border-b flex justify-between items-center" style="border-color: var(--border-color);"><h3 class="text-lg font-bold">Edit Name</h3><button class="modal-close text-gray-500 hover:text-white transition">&times;</button></div>
            <div class="p-6"><input type="text" id="edit-name-input" class="w-full p-3 border rounded-lg bg-transparent focus:ring-1 focus:ring-offset-0" style="border-color: var(--border-color);"></div>
            <div class="p-5 border-t flex justify-end gap-3" style="border-color: var(--border-color);"><button id="edit-name-cancel" class="tool-btn">Cancel</button><button id="edit-name-save" class="tool-btn bg-white text-black dark:bg-white dark:text-black">Save</button></div>
        </div>
    </div>
    
    <!-- Save List Modal -->
    <div id="save-list-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-2xl w-full max-w-md">
            <div class="p-5 border-b" style="border-color: var(--border-color);"><h3 class="text-lg font-bold">Save Group</h3></div>
            <div class="p-6">
                <input type="text" id="save-list-name-input" class="w-full p-3 border rounded-lg bg-transparent focus:ring-1" placeholder="Group Name" style="border-color: var(--border-color);">
            </div>
            <div class="p-5 border-t flex justify-end gap-3" style="border-color: var(--border-color);">
                <button id="save-list-cancel" class="tool-btn">Cancel</button>
                <button id="save-list-confirm" class="tool-btn bg-white text-black dark:bg-white dark:text-black">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Add Modal -->
    <div id="bulk-add-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-2xl w-full max-w-md">
            <div class="p-5 border-b" style="border-color: var(--border-color);"><h3 class="text-lg font-bold">Paste List</h3></div>
            <div class="p-6">
                <p class="text-xs text-gray-500 mb-2 font-mono">Enter names (one per line):</p>
                <textarea id="bulk-add-textarea" class="w-full p-3 border rounded-lg bg-transparent h-48 focus:ring-1 resize-none font-mono text-sm" style="border-color: var(--border-color);" placeholder="Name Surname&#10;Name Surname"></textarea>
            </div>
            <div class="p-5 border-t flex justify-end gap-3" style="border-color: var(--border-color);">
                <button id="bulk-add-cancel" class="tool-btn">Cancel</button>
                <button id="bulk-add-confirm" class="tool-btn bg-white text-black dark:bg-white dark:text-black">Import</button>
            </div>
        </div>
    </div>

    <!-- Load List Modal -->
    <div id="load-list-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-panel rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[80vh]">
            <div class="p-5 border-b" style="border-color: var(--border-color);"><h3 class="text-lg font-bold">Load Group</h3></div>
            <div id="saved-lists-container" class="p-5 overflow-y-auto flex-grow flex flex-col gap-3">
                <!-- Lists will be loaded here -->
                <p class="text-center text-gray-500 text-sm font-mono">Loading...</p>
            </div>
            <div class="p-5 border-t flex justify-end gap-3" style="border-color: var(--border-color);">
                <button id="load-list-cancel" class="tool-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-panel rounded-lg shadow-2xl w-full max-w-sm text-center p-6">
            <h3 id="confirm-title" class="text-lg font-bold mb-2">Confirm</h3>
            <p id="confirm-modal-message" class="text-sm text-gray-500 mb-6"></p>
            <div class="flex justify-center gap-3">
                <button id="confirm-cancel" class="tool-btn">Cancel</button>
                <button id="confirm-ok" class="tool-btn bg-white text-black dark:bg-white dark:text-black">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Alert Modal (Fallback) -->
    <div id="alert-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-panel rounded-lg shadow-2xl w-full max-w-sm text-center p-6">
            <h3 class="text-lg font-bold mb-2">Notice</h3>
            <p id="alert-modal-message" class="text-sm text-gray-500 mb-6"></p>
            <button id="alert-ok" class="tool-btn w-full bg-white text-black dark:bg-white dark:text-black">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, addDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBe1IRZCwUy-1TlP97RRp5biHCu-surkao",
            authDomain: "my-meeting-notes-dbcb4.firebaseapp.com",
            projectId: "my-meeting-notes-dbcb4",
            storageBucket: "my-meeting-notes-dbcb4.appspot.com",
            messagingSenderId: "518603776860",
            appId: "1:518603776860:web:0c1297f45a3a8c75809799"
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                document.getElementById('main-container').style.display = 'none';
                document.querySelector('header').style.display = 'none';
                const setupContainer = document.getElementById('setup-instructions-container');
                setupContainer.innerHTML = `<div class="text-center p-8 bg-red-100 border-2 border-red-500 rounded-lg max-w-3xl mx-auto mt-8"><h2 class="text-2xl font-bold text-red-700 mb-4">⚠️ การตั้งค่ายังไม่สมบูรณ์</h2><p class="text-red-800">คุณยังไม่ได้ตั้งค่า Firebase Configuration (firebaseConfig) ในไฟล์ HTML</p><p class="mt-2 text-gray-700">กรุณาคัดลอกค่า <code>firebaseConfig</code> จากโปรเจกต์ Firebase ของคุณมาวางในโค้ดตามคู่มือที่ให้ไว้ก่อนหน้านี้ เพื่อให้แอปพลิเคชันสามารถทำงานได้</p></div>`;
                return;
            }

            // DOM Elements
            const appContainer = document.getElementById('app-container');
            const ratioToggleBtn = document.getElementById('ratio-toggle');
            const participantsGrid = document.getElementById('participants-grid');
            const transcriptTextarea = document.getElementById('transcript-textarea');
            const transcriptOverlay = document.getElementById('transcript-overlay');
            const addParticipantBtn = document.getElementById('add-participant-btn');
            const decreaseColsBtn = document.getElementById('decrease-cols-btn');
            const increaseColsBtn = document.getElementById('increase-cols-btn');
            const colsCountSpan = document.getElementById('cols-count');
            const saveBtn = document.getElementById('save-btn');
            const downloadBtn = document.getElementById('download-btn');
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const copyAllBtn = document.getElementById('copy-all-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const timestampBtn = document.getElementById('timestamp-btn');
            // search tools removed
            const clockDiv = document.getElementById('clock');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            const toolsHeader = document.getElementById('tools-header');
            const toolsContent = document.getElementById('tools-content');
            const toolsChevron = document.getElementById('tools-chevron');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const excelInput = document.getElementById('excel-input');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const saveListBtn = document.getElementById('save-list-btn');
            const loadListBtn = document.getElementById('load-list-btn');
            
            // New UX Elements
            const saveSpinner = document.getElementById('save-spinner');
            const saveText = document.getElementById('save-text');
            const toastContainer = document.getElementById('toast-container');
            const clearTextBtn = document.getElementById('clear-text-btn');
            
            // Bulk Add Elements
            const bulkAddBtn = document.getElementById('bulk-add-btn');
            const bulkAddModal = document.getElementById('bulk-add-modal');
            const bulkAddTextarea = document.getElementById('bulk-add-textarea');
            const bulkAddConfirmBtn = document.getElementById('bulk-add-confirm');
            const bulkAddCancelBtn = document.getElementById('bulk-add-cancel');

            // Modal Elements
            const allModals = document.querySelectorAll('.modal-overlay');
            const editNameModal = document.getElementById('edit-name-modal');
            const editNameInput = document.getElementById('edit-name-input');
            const editNameSaveBtn = document.getElementById('edit-name-save');
            const editNameCancelBtn = document.getElementById('edit-name-cancel');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-modal-message');
            const confirmOkBtn = document.getElementById('confirm-ok');
            const confirmCancelBtn = document.getElementById('confirm-cancel');
            const alertModal = document.getElementById('alert-modal');
            const alertOkBtn = document.getElementById('alert-ok');
            
            const saveListModal = document.getElementById('save-list-modal');
            const saveListNameInput = document.getElementById('save-list-name-input');
            const saveListConfirmBtn = document.getElementById('save-list-confirm');
            const saveListCancelBtn = document.getElementById('save-list-cancel');
            
            const loadListModal = document.getElementById('load-list-modal');
            const savedListsContainer = document.getElementById('saved-lists-container');
            const loadListCancelBtn = document.getElementById('load-list-cancel');
            
            let app, auth, db, userId, meetingDocRef;
            let unsubscribeMeeting = null;
            
            // Ratio State
            const ratios = ['Auto', '16:9', '4:3'];
            let currentRatioIndex = 0;

            // Undo/Redo State
            let textHistory = [];
            let historyIndex = -1;
            const MAX_HISTORY = 50;

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showToast("การตั้งค่า Firebase ไม่ถูกต้อง", "error");
                return;
            }

            let participants = [];
            let activeParticipantId = null;
            let nextId = 1;
            let columnCount = 2;
            let sortableInstance = null;
            let searchState = { term: '', matches: [], currentIndex: -1 };

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    initializeLogic();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showToast("ไม่สามารถเชื่อมต่อระบบยืนยันตัวตนได้", "error");
                    }
                }
            });

            function initializeLogic() {
                const docId = 'shared_meeting_notes';
                meetingDocRef = doc(db, 'users', userId, 'meetings', docId);

                initSortable();

                unsubscribeMeeting = onSnapshot(meetingDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Update participants if changed
                        if (JSON.stringify(participants) !== JSON.stringify(data.participants)) {
                            participants = data.participants || [];
                            renderParticipants();
                        }
                        
                        const maxId = participants.reduce((max, p) => p.id > max ? p.id : max, 0);
                        nextId = maxId + 1;
                        
                        const serverTranscript = data.transcript || '';
                        
                        if (document.activeElement !== transcriptTextarea) {
                             if(transcriptTextarea.value !== serverTranscript) {
                                 transcriptTextarea.value = serverTranscript;
                                 if (textHistory.length === 0) {
                                     saveToHistory(serverTranscript);
                                 }
                             }
                        } else if (textHistory.length === 0 && serverTranscript) {
                             saveToHistory(serverTranscript);
                        }
                        
                        transcriptTextarea.placeholder = "Click a participant to log...";
                    } else {
                        const defaultData = {
                            name: "Main Meeting",
                            createdAt: new Date().toISOString(),
                            participants: [{ id: 1, name: 'Chair' }, { id: 2, name: 'Member 1' }],
                            transcript: ''
                        };
                        setDoc(meetingDocRef, defaultData);
                    }
                }, (error) => {
                    console.error("Firestore Snapshot Error: ", error);
                    showToast("Error connecting to database", "error");
                });

                updateColumnLayout(getInitialColumnCount());
            }
            
            // --- Toast Logic ---
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'success' ? 'toast-success' : type === 'error' ? 'toast-error' : 'toast-info'}`;
                
                let iconHtml = '';
                if(type === 'success') iconHtml = '<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                else if(type === 'error') iconHtml = '<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                else iconHtml = '<svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';

                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                toastContainer.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }

            // --- Undo/Redo Logic ---
            function saveToHistory(text) {
                if (historyIndex >= 0 && textHistory[historyIndex] === text) return;

                if (historyIndex < textHistory.length - 1) {
                    textHistory = textHistory.slice(0, historyIndex + 1);
                }

                textHistory.push(text);
                if (textHistory.length > MAX_HISTORY) {
                    textHistory.shift();
                } else {
                    historyIndex++;
                }
                updateUndoRedoButtons();
            }

            function updateUndoRedoButtons() {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= textHistory.length - 1;
                
                undoBtn.style.opacity = undoBtn.disabled ? '0.4' : '1';
                redoBtn.style.opacity = redoBtn.disabled ? '0.4' : '1';
            }

            undoBtn.addEventListener('click', () => {
                if (historyIndex > 0) {
                    historyIndex--;
                    const prevText = textHistory[historyIndex];
                    transcriptTextarea.value = prevText;
                    updateUndoRedoButtons();
                    debouncedSave(); 
                }
            });

            redoBtn.addEventListener('click', () => {
                if (historyIndex < textHistory.length - 1) {
                    historyIndex++;
                    const nextText = textHistory[historyIndex];
                    transcriptTextarea.value = nextText;
                    updateUndoRedoButtons();
                    debouncedSave();
                }
            });
            
            clearTextBtn.addEventListener('click', () => {
                if (transcriptTextarea.value.trim() === '') {
                    showToast("Transcript is already empty", "info");
                    return;
                }
                
                confirmTitle.textContent = "Clear Transcript";
                confirmMessage.textContent = "Delete all text in the transcript? You can Undo this action.";
                confirmOkBtn.onclick = () => {
                    saveToHistory(transcriptTextarea.value); // Save current state for undo
                    transcriptTextarea.value = '';
                    saveToHistory(''); // Save empty state
                    
                    debouncedSave();
                    hideAllModals();
                    showToast("Transcript cleared", "success");
                };
                confirmModal.classList.remove('hidden');
            });

            let historyTimeout;
            transcriptTextarea.addEventListener('input', () => {
                clearTimeout(historyTimeout);
                historyTimeout = setTimeout(() => {
                    saveToHistory(transcriptTextarea.value);
                }, 500); 
                
                debouncedSave();
                transcriptOverlay.scrollTop = transcriptTextarea.scrollTop;
            });

            function getInitialColumnCount(){
                 if (window.innerWidth < 640) return 2;
                 if (window.innerWidth < 768) return 3;
                 return 2;
            }

            function initSortable() {
                // ADDED SAFETY CHECK HERE
                if (typeof Sortable === 'undefined') {
                    console.error("Sortable library not loaded.");
                    return;
                }
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(participantsGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    delay: 150,
                    delayOnTouchOnly: true,
                    onEnd: (evt) => {
                        const { oldIndex, newIndex } = evt;
                        const [movedItem] = participants.splice(oldIndex, 1);
                        participants.splice(newIndex, 0, movedItem);
                        saveStateToFirestore();
                    },
                });
            }

            async function saveStateToFirestore() {
                if (!meetingDocRef) return;
                
                saveSpinner.classList.remove('hidden');
                saveText.textContent = "SAVING";
                saveText.parentNode.classList.add('saving');

                try {
                    await updateDoc(meetingDocRef, {
                        participants: participants,
                        transcript: transcriptTextarea.value
                    });
                    
                    setTimeout(() => {
                         saveSpinner.classList.add('hidden');
                         saveText.textContent = "SAVED";
                         saveText.parentNode.classList.remove('saving');
                    }, 800);

                } catch (error) {
                    if (error.code === 'not-found') {
                        await setDoc(meetingDocRef, {
                            participants: participants,
                            transcript: transcriptTextarea.value
                        }, { merge: true });
                    } else {
                        console.error("Error saving state to Firestore: ", error);
                        saveText.textContent = "ERROR";
                    }
                }
            }
            
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            };
            const debouncedSave = debounce(saveStateToFirestore, 1000); 
            
            function renderParticipants() {
                participantsGrid.innerHTML = '';
                if (!participants || participants.length === 0) {
                    participantsGrid.innerHTML = `<p class="col-span-full text-center text-sm" style="color: var(--text-secondary);">No participants yet</p>`;
                    return;
                }
                participants.forEach(p => {
                    const box = document.createElement('div');
                    box.className = 'participant-box p-3 text-center flex flex-col items-center justify-center min-h-[75px] relative';
                    box.dataset.id = p.id;
                    if (p.id === activeParticipantId) box.classList.add('active');
                    
                    const nameElement = document.createElement('h3');
                    // --- FIXED: Use custom line clamp class here ---
                    nameElement.className = 'font-bold text-sm w-full uppercase tracking-wide pointer-events-none px-1 leading-snug custom-line-clamp-2';
                    nameElement.textContent = p.name;
                    
                    // Edit Icon (Pencil) - Bottom Right
                    const editIcon = document.createElement('div');
                    editIcon.className = 'card-action-icon edit-icon';
                    editIcon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>';
                    editIcon.title = "Edit Name";
                    
                    // Delete Icon (X) - Top Right
                    const deleteIcon = document.createElement('div');
                    deleteIcon.className = 'card-action-icon delete-icon';
                    deleteIcon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                    deleteIcon.title = "Remove";

                    box.appendChild(deleteIcon);
                    box.appendChild(nameElement);
                    box.appendChild(editIcon);
                    
                    // Box click handles selection
                    box.addEventListener('click', (e) => {
                        // Prevent selection if clicking icons
                        if (e.target.closest('.card-action-icon')) return;
                        handleParticipantSelect(p.id);
                    });

                    // Icon clicks handle actions
                    editIcon.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        handleNameEdit(p.id); 
                    });
                    
                    deleteIcon.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        handleDeleteParticipant(p.id); 
                    });

                    participantsGrid.appendChild(box);
                });
                initSortable();
            }
            
            function updateColumnLayout(newCount) {
                columnCount = newCount;
                participantsGrid.className = `grid gap-3 grid-cols-${columnCount} mb-4`;
                colsCountSpan.textContent = columnCount;
            }
            
            function hideAllModals() {
                allModals.forEach(modal => modal.classList.add('hidden'));
            }
            
            function handleParticipantSelect(id) {
                activeParticipantId = id;
                renderParticipants();
                const participant = participants.find(p => p.id === id);
                if (!participant) return;
                
                saveToHistory(transcriptTextarea.value);

                const currentText = transcriptTextarea.value;
                // FIXED: No brackets, double spaces around colon
                const textToInsert = `\n${participant.name}  :  `; 
                const newText = (currentText.length > 0 && !currentText.endsWith('\n')) 
                    ? `${currentText}${textToInsert}` 
                    : `${currentText}${textToInsert.trimStart()}`;
                
                transcriptTextarea.value = newText;
                
                saveToHistory(newText);
                
                transcriptTextarea.focus();
                transcriptTextarea.setSelectionRange(transcriptTextarea.value.length, transcriptTextarea.value.length);
                transcriptTextarea.scrollTop = transcriptTextarea.scrollHeight;
                debouncedSave();
            }

            function handleNameEdit(id) {
                const input = editNameInput;
                const participant = participants.find(p => p.id === id);
                if (participant) { 
                    input.dataset.id = id;
                    input.value = participant.name;
                    editNameModal.classList.remove('hidden'); 
                    input.focus();
                }
            }

            editNameSaveBtn.addEventListener('click', () => {
                const newName = editNameInput.value.trim();
                const id = parseInt(editNameInput.dataset.id);
                if (newName && id) {
                    const participant = participants.find(p => p.id === id);
                    if (participant) { 
                        participant.name = newName; 
                        hideAllModals(); 
                        renderParticipants();
                        saveStateToFirestore();
                    }
                }
            });
            
            function handleDeleteParticipant(id) {
                confirmTitle.textContent = "Delete Participant";
                const participant = participants.find(p => p.id === id);
                if (participant) {
                    confirmMessage.textContent = `Are you sure you want to remove "${participant.name}"?`;
                    confirmOkBtn.onclick = () => {
                        participants = participants.filter(p => p.id !== id);
                        renderParticipants();
                        saveStateToFirestore();
                        hideAllModals();
                    };
                    confirmModal.classList.remove('hidden');
                }
            }
            
            clearAllBtn.addEventListener('click', () => {
                if (participants.length === 0) {
                    showToast("No participants to clear", "info");
                    return;
                }
                confirmTitle.textContent = "Clear All";
                confirmMessage.textContent = "Remove all participants? This cannot be undone.";
                confirmOkBtn.onclick = () => {
                    participants = [];
                    activeParticipantId = null;
                    nextId = 1;
                    renderParticipants();
                    saveStateToFirestore();
                    hideAllModals();
                    showToast("Participants cleared", "success");
                };
                confirmModal.classList.remove('hidden');
            });
            
            saveListBtn.addEventListener('click', () => {
                if (participants.length === 0) {
                    showToast("No participants to save", "info");
                    return;
                }
                saveListNameInput.value = '';
                saveListModal.classList.remove('hidden');
            });

            saveListConfirmBtn.addEventListener('click', async () => {
                const listName = saveListNameInput.value.trim();
                if (!listName) {
                    showToast("Please enter a name", "error");
                    return;
                }
                try {
                    const listRef = collection(db, 'users', userId, 'participant_lists');
                    await addDoc(listRef, {
                        name: listName,
                        participants: participants,
                        createdAt: serverTimestamp()
                    });
                    hideAllModals();
                    showToast(`Group "${listName}" saved`, "success");
                } catch (error) {
                    console.error("Error saving list:", error);
                    showToast("Error saving group", "error");
                }
            });

            loadListBtn.addEventListener('click', async () => {
                loadListModal.classList.remove('hidden');
                savedListsContainer.innerHTML = '<p class="text-center text-gray-500 font-mono text-sm">Loading...</p>';
                
                try {
                    const listRef = collection(db, 'users', userId, 'participant_lists');
                    const q = query(listRef, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    savedListsContainer.innerHTML = '';
                    if (querySnapshot.empty) {
                        savedListsContainer.innerHTML = '<p class="text-center text-gray-500 font-mono text-sm">No saved groups</p>';
                        return;
                    }

                    querySnapshot.forEach((docSnap) => {
                        const listData = docSnap.data();
                        const listId = docSnap.id;
                        
                        // Modified item creation for specific contrast request
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'saved-list-item flex justify-between items-center p-4 rounded-lg hover:border-gray-500 transition cursor-pointer mb-2';
                        // Add explicit text colors here for maximum contrast
                        itemDiv.classList.add('text-gray-900', 'dark:text-white');
                        
                        itemDiv.onclick = () => loadGroupAction(listData.participants);

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'font-bold flex-grow text-sm uppercase tracking-wide';
                        nameSpan.textContent = listData.name + ` (${listData.participants ? listData.participants.length : 0})`;

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'list-item-action text-gray-500 hover:text-white p-2 rounded-full transition';
                        deleteBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteGroupAction(listId, itemDiv);
                        };

                        itemDiv.appendChild(nameSpan);
                        itemDiv.appendChild(deleteBtn);
                        savedListsContainer.appendChild(itemDiv);
                    });
                } catch (error) {
                    console.error("Error loading lists:", error);
                    savedListsContainer.innerHTML = '<p class="text-center text-red-500">Failed to load</p>';
                }
            });

            function loadGroupAction(loadedParticipants) {
                 if (!loadedParticipants || !Array.isArray(loadedParticipants)) {
                     showToast("Invalid group data", "error");
                     return;
                 }
                 
                 loadListModal.classList.add('hidden');

                 confirmTitle.textContent = "Load Group";
                 confirmMessage.textContent = "This will replace current participants. Continue?";
                 confirmOkBtn.onclick = () => {
                     participants = JSON.parse(JSON.stringify(loadedParticipants));
                     const maxId = participants.reduce((max, p) => p.id > max ? p.id : max, 0);
                     nextId = maxId + 1;
                     
                     renderParticipants();
                     saveStateToFirestore();
                     hideAllModals();
                     showToast("Group loaded", "success");
                 };
                 confirmModal.classList.remove('hidden');
            }

            async function deleteGroupAction(docId, elementToRemove) {
                if(confirm("Delete this group permanently?")) {
                    try {
                        await deleteDoc(doc(db, 'users', userId, 'participant_lists', docId));
                        elementToRemove.remove();
                        if (savedListsContainer.children.length === 0) {
                            savedListsContainer.innerHTML = '<p class="text-center text-gray-500">No saved groups</p>';
                        }
                    } catch(error) {
                         console.error("Error deleting list:", error);
                         showToast("Failed to delete", "error");
                    }
                }
            }


            transcriptTextarea.addEventListener('scroll', () => {
                transcriptOverlay.scrollTop = transcriptTextarea.scrollTop;
            });
            
            addParticipantBtn.addEventListener('click', () => {
                const newParticipant = { id: nextId, name: `Member ${nextId}` };
                nextId++;
                participants.push(newParticipant);
                renderParticipants();
                saveStateToFirestore();
            });
            
            // Bulk Add Logic
            bulkAddBtn.addEventListener('click', () => {
                bulkAddTextarea.value = '';
                bulkAddModal.classList.remove('hidden');
                bulkAddTextarea.focus();
            });

            bulkAddConfirmBtn.addEventListener('click', () => {
                const text = bulkAddTextarea.value;
                const names = text.split('\n').map(n => n.trim()).filter(n => n);
                
                if (names.length === 0) {
                    showToast("No names entered", "info");
                    return;
                }

                let addedCount = 0;
                names.forEach(name => {
                    participants.push({ id: nextId, name: name });
                    nextId++;
                    addedCount++;
                });

                renderParticipants();
                saveStateToFirestore();
                hideAllModals();
                showToast(`Added ${addedCount} participants`, "success");
            });
            
            bulkAddCancelBtn.addEventListener('click', hideAllModals);

            importExcelBtn.addEventListener('click', () => {
                excelInput.click();
            });

            excelInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    try {
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        let addedCount = 0;
                        if (jsonData && jsonData.length > 0) {
                            jsonData.forEach(row => {
                                if (row.length > 0 && row[0]) {
                                    const name = String(row[0]).trim();
                                    if (name) {
                                        participants.push({ id: nextId, name: name });
                                        nextId++;
                                        addedCount++;
                                    }
                                }
                            });
                            
                            if (addedCount > 0) {
                                renderParticipants();
                                saveStateToFirestore();
                                showToast(`Imported ${addedCount} members`, "success");
                            } else {
                                showToast("No names found", "info");
                            }
                        } else {
                            showToast("File is empty", "info");
                        }
                    } catch (error) {
                        console.error("Excel Import Error:", error);
                        showToast("Import error", "error");
                    }
                    excelInput.value = ''; 
                };
                reader.readAsArrayBuffer(file);
            });

            increaseColsBtn.addEventListener('click', () => { if (columnCount < 6) updateColumnLayout(columnCount + 1); });
            decreaseColsBtn.addEventListener('click', () => { if (columnCount > 1) updateColumnLayout(columnCount - 1); });

            saveBtn.addEventListener('click', () => {
                saveStateToFirestore();
                showToast("Saved successfully", "success");
            });

            downloadBtn.addEventListener('click', () => {
                const text = transcriptTextarea.value;
                if (text.trim() === '') {
                    showToast('Nothing to download', "info");
                    return;
                }

                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                    "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                    "xmlns='http://www.w3.org/TR/REC-html40'>"+
                    "<head><meta charset='utf-8'><title>Meeting Notes</title></head><body>";
                const footer = "</body></html>";
                const content = `<pre>${text.replace(/\t/g, '&#9;')}</pre>`;
                const sourceHTML = header + content + footer;

                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `meeting-notes-${new Date().toISOString().slice(0,10)}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
                showToast("Downloading Word doc...", "success");
            });
            
            copyAllBtn.addEventListener('click', () => {
                const textToCopy = transcriptTextarea.value;
                if (textToCopy.trim() === '') { showToast('Nothing to copy', 'info'); return; }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Copied to clipboard', 'success');
                }, () => {
                    showToast('Copy failed', 'error');
                });
            });

            ratioToggleBtn.addEventListener('click', () => {
                currentRatioIndex = (currentRatioIndex + 1) % ratios.length;
                const newRatio = ratios[currentRatioIndex];
                ratioToggleBtn.textContent = newRatio.toUpperCase();
                
                appContainer.classList.remove('ratio-mode', 'ratio-16-9', 'ratio-4-3', 'h-screen');
                document.body.classList.remove('has-ratio');

                if (newRatio === 'Auto') {
                    appContainer.classList.add('h-screen'); 
                    showToast("Auto Ratio (Full Screen)");
                } else {
                    appContainer.classList.add('ratio-mode');
                    document.body.classList.add('has-ratio');
                    if (newRatio === '16:9') {
                        appContainer.classList.add('ratio-16-9');
                        showToast("16:9 Aspect Ratio");
                    } else if (newRatio === '4:3') {
                        appContainer.classList.add('ratio-4-3');
                        showToast("4:3 Aspect Ratio");
                    }
                }
            });


            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                document.getElementById('theme-icon-light').classList.toggle('hidden');
                document.getElementById('theme-icon-dark').classList.toggle('hidden');
                localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
            });
            if (localStorage.getItem('theme') === 'dark' || true) { // Force Dark default for demo
                document.body.classList.add('dark');
                document.getElementById('theme-icon-light').classList.add('hidden');
                document.getElementById('theme-icon-dark').classList.remove('hidden');
            }

            timestampBtn.addEventListener('click', insertTimestamp);
            function insertTimestamp() {
                saveToHistory(transcriptTextarea.value); 
                const now = new Date();
                const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}] `;
                const start = transcriptTextarea.selectionStart;
                const end = transcriptTextarea.selectionEnd;
                transcriptTextarea.value = transcriptTextarea.value.substring(0, start) + timeString + transcriptTextarea.value.substring(end);
                
                saveToHistory(transcriptTextarea.value);

                transcriptTextarea.selectionStart = transcriptTextarea.selectionEnd = start + timeString.length;
                transcriptTextarea.focus();
                saveStateToFirestore();
            }
            
            toggleSidebarBtn.addEventListener('click', () => {
                leftPanel.classList.toggle('hidden');
                resizer.classList.toggle('hidden');
                if (leftPanel.classList.contains('hidden')) {
                     rightPanel.style.flexBasis = '100%';
                     if(window.innerWidth < 768) {
                        leftPanel.style.display = 'none'; 
                     }
                } else {
                     rightPanel.style.flexBasis = '67%'; 
                     if(window.innerWidth < 768) {
                        leftPanel.style.display = 'flex';
                     }
                }
            });
            
            toolsHeader.addEventListener('click', () => {
                toolsContent.classList.toggle('hidden');
                toolsChevron.classList.toggle('rotate-180');
                if (toolsContent.classList.contains('hidden')) {
                    toolsContent.style.marginTop = '0';
                } else {
                     toolsContent.style.marginTop = '0.5rem';
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    if (e.key === 's') { e.preventDefault(); saveBtn.click(); } 
                    else if (e.key === 't') { e.preventDefault(); insertTimestamp(); } 
                    else if (e.key === 'z') { e.preventDefault(); undoBtn.click(); } 
                    else if (e.key === 'y') { e.preventDefault(); redoBtn.click(); } 
                    else if (!isNaN(parseInt(e.key)) && e.key >= '1' && e.key <= '9') {
                        e.preventDefault();
                        const participantIndex = parseInt(e.key) - 1;
                        if (participants && participants[participantIndex]) {
                            handleParticipantSelect(participants[participantIndex].id);
                        }
                    }
                }
            });

            let isResizing = false;
            const handleMouseMove = (e) => {
                if (!isResizing) return;
                const event = e.touches ? e.touches[0] : e;
                const container = document.getElementById('main-container');
                const containerRect = container.getBoundingClientRect();
                let newLeftWidth = event.clientX - containerRect.left;
                const minWidth = 250;
                if (newLeftWidth < minWidth) newLeftWidth = minWidth;
                if (newLeftWidth > containerRect.width - minWidth - resizer.offsetWidth) {
                    newLeftWidth = containerRect.width - minWidth - resizer.offsetWidth;
                }
                leftPanel.style.flexBasis = `${newLeftWidth}px`;
            };
            const stopResizing = () => {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', stopResizing);
                document.removeEventListener('touchmove', handleMouseMove);
                document.removeEventListener('touchend', stopResizing);
            };
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('resizing');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', stopResizing);
            });
            resizer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('resizing');
                document.addEventListener('touchmove', handleMouseMove);
                document.addEventListener('touchend', stopResizing);
            });
            
            setInterval(() => {
                const now = new Date();
                clockDiv.textContent = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }, 1000);

            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', hideAllModals));
            allModals.forEach(modal => modal.addEventListener('click', (e) => { if(e.target === modal) hideAllModals(); }));
            editNameCancelBtn.addEventListener('click', hideAllModals);
            saveListCancelBtn.addEventListener('click', hideAllModals);
            loadListCancelBtn.addEventListener('click', hideAllModals);
            confirmCancelBtn.addEventListener('click', hideAllModals);
            alertOkBtn.addEventListener('click', hideAllModals);
        });
    </script>
</body>
</html>
```eof
