<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f8f7f4;
            --bg-panel: #ffffff;
            --text-primary: #4a4a4a;
            --text-secondary: #7a7a7a;
            --border-color: #e5e5e5;
            --accent-color: #84a98c;
            --accent-hover: #6e9a78;
            --focus-ring: rgba(132, 169, 140, 0.4);
            
            /* Button Colors */
            --btn-action-item-bg: #588157;
            --btn-save-bg: #b08968;
            --btn-download-bg: #7f7f7f;
            --btn-format-bg: #9a8c98;
            --btn-copy-bg: #4a4e69;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        .participant-box {
            background-color: var(--bg-panel);
            border: 2px solid var(--border-color);
            transition: all 0.2s ease-in-out;
            position: relative;
            cursor: grab;
        }
        .participant-box:active {
            cursor: grabbing;
        }
        .participant-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .participant-box.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebcf;
        }
        .sortable-drag {
            opacity: 1 !important;
        }

        textarea {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
        }
        textarea:focus {
            box-shadow: 0 0 0 3px var(--focus-ring);
            border-color: var(--accent-color);
        }
        .delete-icon {
            position: absolute; top: 0.25rem; right: 0.5rem; cursor: pointer; color: #d9534f;
            font-weight: bold; display: none; font-size: 1.25rem; line-height: 1;
        }
        .participant-box:hover .delete-icon { display: block; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .tool-btn {
            font-size: 0.875rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem;
            color: white; font-weight: 500; transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        #resizer {
            width: 8px;
            cursor: col-resize;
            background-color: #e5e7eb;
            transition: background-color 0.2s;
        }
        #resizer:hover, #resizer.resizing {
            background-color: var(--accent-color);
        }
        /* Button Classes */
        .btn-action-item { background-color: var(--btn-action-item-bg); }
        .btn-save { background-color: var(--btn-save-bg); }
        .btn-download { background-color: var(--btn-download-bg); }
        .btn-format { background-color: var(--btn-format-bg); }
        .btn-copy { background-color: var(--btn-copy-bg); }

        .btn-action-item:hover { background-color: #4a6d49; }
        .btn-save:hover { background-color: #9c7853; }
        .btn-download:hover { background-color: #6b6b6b; }
        .btn-format:hover { background-color: #857884; }
        .btn-copy:hover { background-color: #3e4157; }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            html, body {
                height: auto;
                overflow: auto;
            }
            #left-panel, #right-panel {
                flex-basis: auto !important;
                width: 100%;
                padding: 0;
            }
             #right-panel {
                min-height: 300px;
            }
            #main-container {
                 flex-direction: column;
                 gap: 1rem;
            }
            #resizer {
                display: none;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 h-screen flex flex-col">
        <header class="text-center mb-6 flex-shrink-0">
            <h1 class="text-3xl md:text-4xl font-bold">Meeting Notes</h1>
            <p style="color: var(--text-secondary);" class="mt-2">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
        </header>

        <!-- This container will be hidden if Firebase is configured correctly -->
        <div id="setup-instructions-container"></div>

        <main id="main-container" class="flex flex-grow min-h-0">

            <!-- Left Column: Participants & AI Tools -->
            <div id="left-panel" class="flex flex-col gap-6 md:pr-3 overflow-y-auto" style="flex-basis: 33%; min-width: 250px;">
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>
                        <div class="flex items-center gap-2">
                            <button id="decrease-cols-btn" class="w-7 h-7 rounded-full bg-gray-200 hover:bg-gray-300 font-bold flex items-center justify-center transition">-</button>
                            <span id="cols-count" class="font-bold w-4 text-center">2</span>
                            <button id="increase-cols-btn" class="w-7 h-7 rounded-full bg-gray-200 hover:bg-gray-300 font-bold flex items-center justify-center transition">+</button>
                        </div>
                    </div>
                    <div id="participants-grid" class="grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-2">
                        <!-- JS Generated -->
                    </div>
                    <div class="mt-4">
                        <button id="add-participant-btn" class="tool-btn w-full" style="background-color: var(--accent-color);">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                        </button>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-4">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h2>
                    <div class="grid grid-cols-2 gap-2">
                         <button id="action-items-btn" class="tool-btn btn-action-item col-span-2">
                            üìã ‡∏™‡∏£‡∏∏‡∏õ Action Items
                        </button>
                        <button id="save-btn" class="tool-btn btn-save">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </button>
                        <button id="download-btn" class="tool-btn btn-download">
                            üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                        </button>
                        <button id="format-text-btn" class="tool-btn btn-format">
                            ‚úçÔ∏è ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
                         </button>
                         <button id="copy-all-btn" class="tool-btn btn-copy">
                            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                         </button>
                    </div>
                </div>
            </div>

            <div id="resizer"></div>

            <!-- Right Column: Transcript Area -->
            <div id="right-panel" class="flex flex-col md:pl-3" style="flex-basis: 67%; min-width: 0;">
                 <div class="bg-white p-6 rounded-xl shadow-sm h-full flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <textarea id="transcript-textarea" class="w-full flex-grow p-4 rounded-lg focus:outline-none" placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."></textarea>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="edit-name-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center"><h3 class="text-xl font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3><button class="modal-close text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div>
            <div class="p-6"><label for="edit-name-input" class="block mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:</label><input type="text" id="edit-name-input" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="p-4 border-t flex justify-end gap-2"><button id="edit-name-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="edit-name-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>
    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center"><h3 id="summary-modal-title" class="text-xl font-bold">‡∏™‡∏£‡∏∏‡∏õ Action Items</h3><button class="modal-close text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div>
            <div id="summary-modal-content" class="p-6 overflow-y-auto"></div>
            <div class="p-4 border-t flex justify-end gap-2"><button id="summary-modal-copy" class="tool-btn bg-gray-600 hover:bg-gray-700">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button></div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b"><h3 class="text-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3></div>
            <div class="p-6"><p id="confirm-modal-message"></p></div>
            <div class="p-4 border-t flex justify-end gap-2"><button id="confirm-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b"><h3 class="text-xl font-bold">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3></div>
            <div class="p-6"><p id="alert-modal-message"></p></div>
            <div class="p-4 border-t flex justify-end gap-2"><button id="alert-ok" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button></div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ß‡∏≤‡∏á firebaseConfig ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Firebase Console (‡∏î‡∏π‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠)
        const firebaseConfig = {
            apiKey: "AIzaSyBe1IRZCwUy-1TlP97RRp5biHCu-surkao",
            authDomain: "my-meeting-notes-dbcb4.firebaseapp.com",
            projectId: "my-meeting-notes-dbcb4",
            storageBucket: "my-meeting-notes-dbcb4.firebasestorage.app",
            messagingSenderId: "518603776860",
            appId: "1:518603776860:web:0c1297f45a3a8c75809799"
        };
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // --- FIXED: Check for valid Firebase config before doing anything else ---
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                document.getElementById('main-container').style.display = 'none';
                const setupContainer = document.getElementById('setup-instructions-container');
                setupContainer.innerHTML = `
                    <div class="text-center p-8 bg-red-100 border-2 border-red-500 rounded-lg max-w-3xl mx-auto mt-8">
                        <h2 class="text-2xl font-bold text-red-700 mb-4">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</h2>
                        <p class="text-red-800">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Configuration (firebaseConfig) ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML</p>
                        <p class="mt-2 text-gray-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤ <code>firebaseConfig</code> ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
                return; // Stop script execution
            }

            // DOM Elements
            const participantsGrid = document.getElementById('participants-grid');
            const transcriptTextarea = document.getElementById('transcript-textarea');
            const addParticipantBtn = document.getElementById('add-participant-btn');
            const actionItemsBtn = document.getElementById('action-items-btn');
            const decreaseColsBtn = document.getElementById('decrease-cols-btn');
            const increaseColsBtn = document.getElementById('increase-cols-btn');
            const colsCountSpan = document.getElementById('cols-count');
            const saveBtn = document.getElementById('save-btn');
            const downloadBtn = document.getElementById('download-btn');
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const formatTextBtn = document.getElementById('format-text-btn');
            const copyAllBtn = document.getElementById('copy-all-btn');

            // Modal Elements
            const allModals = document.querySelectorAll('.modal-overlay');
            const summaryModal = document.getElementById('summary-modal');
            const summaryModalContent = document.getElementById('summary-modal-content');
            const summaryModalCopyBtn = document.getElementById('summary-modal-copy');
            const editNameModal = document.getElementById('edit-name-modal');
            const editNameInput = document.getElementById('edit-name-input');
            const editNameSaveBtn = document.getElementById('edit-name-save');
            const editNameCancelBtn = document.getElementById('edit-name-cancel');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmOkBtn = document.getElementById('confirm-ok');
            const confirmCancelBtn = document.getElementById('confirm-cancel');
            const alertModal = document.getElementById('alert-modal');
            const alertOkBtn = document.getElementById('alert-ok');
            
            // --- Firebase Setup ---
            let app, auth, db, userId, meetingDocRef;
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showAlert("‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ firebaseConfig");
                return;
            }

            // Application State
            let participants = [];
            let activeParticipantId = null;
            let nextId = 1;
            let columnCount = 2;
            let sortableInstance = null;


            // --- Authentication ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User signed in with UID:", userId);
                    initializeLogic();
                } else {
                    console.log("No user signed in, attempting anonymous sign-in.");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ", "error");
                    }
                }
            });

            // --- Core Logic ---
            function initializeLogic() {
                const docId = 'shared_meeting_notes'; // You can change this to have multiple separate meeting notes
                meetingDocRef = doc(db, 'meetings', docId);

                initSortable();

                onSnapshot(meetingDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        console.log("Received data from Firestore:", data);
                        
                        if (JSON.stringify(participants) !== JSON.stringify(data.participants)) {
                            participants = data.participants || [];
                            renderParticipants();
                        }
                        
                        const maxId = participants.reduce((max, p) => p.id > max ? p.id : max, 0);
                        nextId = maxId + 1;
                        
                        const serverTranscript = data.transcript || '';
                        if (document.activeElement !== transcriptTextarea) {
                             transcriptTextarea.value = serverTranscript;
                        }
                        
                        transcriptTextarea.placeholder = "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

                    } else {
                        console.log("Document does not exist. Creating a new one.");
                        participants = [
                            { id: 1, name: '‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô' }, { id: 2, name: '‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î' },
                        ];
                        nextId = 3;
                        transcriptTextarea.value = '';
                        transcriptTextarea.placeholder = "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                        renderParticipants();
                        saveStateToFirestore();
                    }
                }, (error) => {
                    console.error("Firestore Snapshot Error: ", error);
                    showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
                });

                updateColumnLayout(getInitialColumnCount());
            }
            
            function getInitialColumnCount(){
                 if (window.innerWidth < 640) return 2;
                 if (window.innerWidth < 768) return 3;
                 return 2;
            }

            function initSortable() {
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                sortableInstance = new Sortable(participantsGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        const { oldIndex, newIndex } = evt;
                        const [movedItem] = participants.splice(oldIndex, 1);
                        participants.splice(newIndex, 0, movedItem);
                        saveStateToFirestore();
                    },
                });
            }

            async function saveStateToFirestore() {
                if (!meetingDocRef) {
                    console.warn("Firestore document reference not ready.");
                    return;
                }
                try {
                    await setDoc(meetingDocRef, {
                        participants: participants,
                        transcript: transcriptTextarea.value,
                        lastUpdatedBy: userId,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    console.log("State saved to Firestore.");
                } catch (error) {
                    console.error("Error saving state to Firestore: ", error);
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            }
            
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            };
            const debouncedSave = debounce(saveStateToFirestore, 1500);
            
            function renderParticipants() {
                participantsGrid.innerHTML = '';
                if (participants.length === 0) {
                    participantsGrid.innerHTML = `<p class="col-span-full text-center" style="color: var(--text-secondary);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</p>`;
                    return;
                }
                participants.forEach(p => {
                    const box = document.createElement('div');
                    box.className = 'participant-box p-3 rounded-lg text-center';
                    box.dataset.id = p.id;
                    if (p.id === activeParticipantId) box.classList.add('active');

                    const nameElement = document.createElement('h3');
                    nameElement.className = 'font-bold text-sm truncate';
                    nameElement.textContent = p.name;
                    
                    const editButton = document.createElement('button');
                    editButton.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                    editButton.className = 'text-xs w-full mt-1 hover:underline';
                    editButton.style.color = 'var(--text-secondary)';
                    
                    const deleteIcon = document.createElement('span');
                    deleteIcon.className = 'delete-icon';
                    deleteIcon.innerHTML = '&times;';
                    
                    box.appendChild(deleteIcon);
                    box.appendChild(nameElement);
                    box.appendChild(editButton);
                    
                    box.addEventListener('click', () => handleParticipantSelect(p.id));
                    editButton.addEventListener('click', (e) => { e.stopPropagation(); handleNameEdit(p.id); });
                    deleteIcon.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteParticipant(p.id); });
                    
                    participantsGrid.appendChild(box);
                });
            }
            
            function updateColumnLayout(newCount) {
                columnCount = newCount;
                participantsGrid.className = `grid gap-4 grid-cols-${columnCount}`;
                colsCountSpan.textContent = columnCount;
            }
            
            function hideAllModals() {
                allModals.forEach(modal => modal.classList.add('hidden'));
            }
            
            function showAlert(message) {
                const alertModal = document.getElementById('alert-modal');
                document.getElementById('alert-modal-message').textContent = message;
                alertModal.classList.remove('hidden');
            }

            function handleParticipantSelect(id) {
                activeParticipantId = id;
                renderParticipants();
                const participant = participants.find(p => p.id === id);
                if (!participant) return;
                
                const currentText = transcriptTextarea.value;
                const textToInsert = `\t${participant.name}  :  `;
                
                const newText = (currentText.length > 0 && !currentText.endsWith('\n')) 
                    ? `${currentText}\n${textToInsert}` 
                    : `${currentText}${textToInsert}`;

                transcriptTextarea.value = newText;
                transcriptTextarea.focus();
                
                transcriptTextarea.setSelectionRange(transcriptTextarea.value.length, transcriptTextarea.value.length);
                transcriptTextarea.scrollTop = transcriptTextarea.scrollHeight;
                
                debouncedSave();
            }

            function handleNameEdit(id) {
                const input = editNameInput;
                const participant = participants.find(p => p.id === id);
                if (participant) { 
                    input.dataset.id = id;
                    input.value = participant.name;
                    editNameModal.classList.remove('hidden'); 
                    input.focus();
                }
            }

            editNameSaveBtn.addEventListener('click', () => {
                const newName = editNameInput.value.trim();
                const id = parseInt(editNameInput.dataset.id);
                if (newName && id) {
                    const participant = participants.find(p => p.id === id);
                    if (participant) { 
                        participant.name = newName; 
                        hideAllModals(); 
                        renderParticipants();
                        saveStateToFirestore();
                    }
                }
            });
            
            function handleDeleteParticipant(id) {
                const message = document.getElementById('confirm-modal-message');
                const participant = participants.find(p => p.id === id);
                if (participant) {
                    message.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${participant.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠?`;
                    confirmModal.dataset.id = id;
                    confirmModal.classList.remove('hidden');
                }
            }

            confirmOkBtn.addEventListener('click', () => {
                const id = parseInt(confirmModal.dataset.id);
                if(id) {
                    participants = participants.filter(p => p.id !== id);
                    renderParticipants();
                    saveStateToFirestore();
                    hideAllModals();
                }
            });
            
            transcriptTextarea.addEventListener('input', debouncedSave);
            
            addParticipantBtn.addEventListener('click', () => {
                const newParticipant = { id: nextId, name: `‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ${nextId}` };
                nextId++;
                participants.push(newParticipant);
                renderParticipants();
                saveStateToFirestore();
            });

            increaseColsBtn.addEventListener('click', () => { if (columnCount < 4) updateColumnLayout(columnCount + 1); });
            decreaseColsBtn.addEventListener('click', () => { if (columnCount > 1) updateColumnLayout(columnCount - 1); });

            saveBtn.addEventListener('click', () => {
                saveStateToFirestore();
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                setTimeout(() => { saveBtn.innerHTML = originalText; }, 2000);
            });

            downloadBtn.addEventListener('click', () => {
                const text = transcriptTextarea.value;
                if (text.trim() === '') { showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); return; }
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `meeting-notes-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            copyAllBtn.addEventListener('click', () => {
                const textToCopy = transcriptTextarea.value;
                if (textToCopy.trim() === '') {
                    showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
                    return;
                }
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = textToCopy;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                tempTextarea.setSelectionRange(0, 99999);
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showAlert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
                    }
                } catch (err) {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
                    console.error('Copy command failed', err);
                }
                document.body.removeChild(tempTextarea);
            });

            formatTextBtn.addEventListener('click', () => {
                const originalText = transcriptTextarea.value;
                if (originalText.trim() === '') {
                    showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö');
                    return;
                }
                const lines = originalText.split('\n');
                const formattedLines = lines.map(line => {
                    const separator = '  :  ';
                    if (line.includes(separator)) {
                        const parts = line.split(separator);
                        let speakerPart = parts[0];
                        let speechPart = parts.slice(1).join(separator);
                        const thaiNumerals = ['‡πê', '‡πë', '‡πí', '‡πì', '‡πî', '‡πï', '‡πñ', '‡πó', '‡πò', '‡πô'];
                        speechPart = speechPart.replace(/[0-9]/g, d => thaiNumerals[d]);
                        const fillerWords = /‡∏Ñ‡∏£‡∏±‡∏ö‡∏ú‡∏°|‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö|‡∏Ñ‡∏£‡∏±‡∏ö|‡∏Ñ‡πà‡∏∞|‡∏Ñ‡∏∞/g;
                        speechPart = speechPart.replace(fillerWords, '');
                        speechPart = speechPart.replace(/‡πÑ‡∏´‡∏°/g, '‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà');
                        speechPart = speechPart.replace(/‡∏¢‡∏±‡∏á‡πÑ‡∏á/g, '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£');
                        speechPart = speechPart.replace(/‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ/g, '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                        speechPart = speechPart.replace(/ +/g, ' ').trim();
                        return `${speakerPart}${separator}${speechPart}`;
                    }
                    return line; 
                });
                const newText = formattedLines.join('\n');
                transcriptTextarea.value = newText;
                saveStateToFirestore();
                showAlert('‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            });
            
            actionItemsBtn.addEventListener('click', () => {
                const fullNotes = transcriptTextarea.value;
                if (fullNotes.trim() === '') {
                    showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ');
                    return;
                }
                const keywords = ["‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢", "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥", "‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡∏ù‡∏≤‡∏Å", "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°", "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"];
                const lines = fullNotes.split('\n');
                const actionItems = lines.filter(line => {
                    const parts = line.split(' : ');
                    if (parts.length > 1) {
                        const speechPart = parts[1];
                        return keywords.some(keyword => speechPart.includes(keyword));
                    }
                    return false;
                });
                summaryModal.classList.remove('hidden');
                if (actionItems.length > 0) {
                    summaryModalContent.innerHTML = actionItems.map(item => `<div>${item.trim()}</div>`).join('');
                } else {
                    summaryModalContent.innerHTML = `<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö Action Items ‡πÉ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</p>`;
                }
            });

            summaryModalCopyBtn.addEventListener('click', () => {
                const content = summaryModalContent.innerText;
                 if (content.trim() === '' || content.includes("‡πÑ‡∏°‡πà‡∏û‡∏ö Action Items")) {
                    showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
                    return;
                }
                navigator.clipboard.writeText(content).then(() => {
                    showAlert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ Action Items ‡πÅ‡∏•‡πâ‡∏ß');
                }, () => {
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
                });
            });

            let isResizing = false;
            const handleMouseMove = (e) => {
                if (!isResizing) return;
                const container = document.getElementById('main-container');
                const containerRect = container.getBoundingClientRect();
                const resizerWidth = resizer.offsetWidth;
                let newLeftWidth = e.clientX - containerRect.left;
                const minWidth = 250;
                if (newLeftWidth < minWidth) newLeftWidth = minWidth;
                if (newLeftWidth > containerRect.width - minWidth - resizerWidth) {
                    newLeftWidth = containerRect.width - minWidth - resizerWidth;
                }
                leftPanel.style.flexBasis = `${newLeftWidth}px`;
            };
            const stopResizing = () => {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', stopResizing);
            };
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('resizing');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', stopResizing);
            });

            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', hideAllModals));
            allModals.forEach(modal => modal.addEventListener('click', (e) => { if(e.target === modal) hideAllModals(); }));
            editNameCancelBtn.addEventListener('click', hideAllModals);
            confirmCancelBtn.addEventListener('click', hideAllModals);
            alertOkBtn.addEventListener('click', hideAllModals);
        });
    </script>
</body>
</html>

